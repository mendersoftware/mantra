variables:
  DOCKER_HOST:
    value: "tcp://docker:2376"
    description: "Required to run dind inside k8s runners with TLS"
  DOCKER_TLS_CERTDIR:
    value: "/certs"
    description: "The cert dir inside the gitlab runner. Don't change this."
  DOCKER_TLS_VERIFY:
    value: 1
    description: "Enable TLS verification for docker in dind"
  DOCKER_CERT_PATH:
    value: "$DOCKER_TLS_CERTDIR/client"
    description: "Used for docker entrypoints. See https://gitlab.com/gitlab-org/gitlab-runner/-/issues/4125"

stages:
  - test
  - build
  - acceptance_tests
  - publish
  - sync

include:
  - project: 'Northern.tech/Mender/mendertesting'
    file: '.gitlab-ci-check-commits-signoffs.yml'
  - project: 'Northern.tech/Mender/mendertesting'
    file: '.gitlab-ci-check-docker-build.yml'
  - project: 'Northern.tech/Mender/mendertesting'
    file: '.gitlab-ci-check-docker-deploy.yml'
  - project: 'Northern.tech/Mender/mendertesting'
    file: '.gitlab-ci-github-status-updates.yml'

default:
  tags:
    - k8s
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Disable Mender specific job
publish:image:mender:
  rules:
    - when: never

test:check-python3-formatting:
  stage: test
  needs: []
  image: python:3
  before_script:
    - pip install tox
    - cd backend
  script:
    - TOXENV=black tox

test:backend-unit:
  stage: test
  needs: []
  services:
    - name: postgres:12.22-bullseye
      alias: db
  variables:
    POSTGRES_PASSWORD: password
    POSTGRES_DB: mantra-db
  image: python:3.12
  before_script:
    - cd backend
    - pip install -r requirements.txt
    - pip install tox
  script:
    - gunicorn -t 120 --daemon --bind 127.0.0.1:7374 --access-logfile - tetra.app:application
    - TOXENV=functional tox

build:docker:
  variables:
    DOCKER_REPOSITORY: mendersoftware/mantra-api
    DOCKER_DIR: backend
  after_script:
    - cp image.tar image-api.tar
  artifacts:
    expire_in: 2w
    paths:
      - image.tar
      - image-api.tar
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
    - changes:
        - backend/**/*
  tags:
    - k8s

publish:image:
  variables:
    DOCKER_REPOSITORY: mendersoftware/mantra-api
    DOCKER_DIR: backend

sync:image:
  variables:
    DOCKER_REPOSITORY: mendersoftware/mantra-api
    TARGET_MANIFEST_FILE: kubernetes/mender-qastatus/api-deployment.yaml

build:docker:ui:
  extends: build:docker
  variables:
    DOCKER_REPOSITORY: mendersoftware/mantra-ui
    DOCKER_DIR: ui
  script:
    - echo "building ${CI_PROJECT_NAME} for ${DOCKER_BUILD_SERVICE_IMAGE}"
    - docker build
      --secret id=aws_access_key_id,env=AWS_ACCESS_KEY_ID
      --secret id=aws_secret_access_key,env=AWS_SECRET_ACCESS_KEY
      --secret id=gitlab_token,env=GITLAB_TOKEN
      --secret id=github_token,env=GITHUB_BOT_TOKEN_REPO_FULL
      --tag $DOCKER_BUILD_SERVICE_IMAGE
      --file ${DOCKER_DIR:-.}/${DOCKERFILE:-Dockerfile}
      ${DOCKER_DIR:-.}
    - docker save $DOCKER_BUILD_SERVICE_IMAGE > image.tar
    - echo "extracting repoBuildStatus.json from builder stage"
    - docker build
      --secret id=aws_access_key_id,env=AWS_ACCESS_KEY_ID
      --secret id=aws_secret_access_key,env=AWS_SECRET_ACCESS_KEY
      --secret id=gitlab_token,env=GITLAB_TOKEN
      --secret id=github_token,env=GITHUB_BOT_TOKEN_REPO_FULL
      --target builder
      --tag ${DOCKER_BUILD_SERVICE_IMAGE}-builder
      --file ${DOCKER_DIR:-.}/${DOCKERFILE:-Dockerfile}
      ${DOCKER_DIR:-.}
    - CONTAINER_ID=$(docker create ${DOCKER_BUILD_SERVICE_IMAGE}-builder)
    - docker cp ${CONTAINER_ID}:/work/repoBuildStatus.json ui/repoBuildStatus.json
    - docker rm ${CONTAINER_ID}
  after_script:
    - cp image.tar image-ui.tar
  artifacts:
    expire_in: 2w
    paths:
      - image.tar
      - image-ui.tar
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
    - changes:
        - ui/**/*

test:composition:
  stage: acceptance_tests
  image: tiangolo/docker-with-compose
  needs:
    - job: build:docker
      artifacts: true
    - job: build:docker:ui
      artifacts: true
  services:
    - docker:20.10.8-dind
  before_script:
    - docker load -i image-api.tar
    - docker tag mendersoftware/mantra-api:${CI_COMMIT_REF_SLUG} mendersoftware/mantra-api:pr
    - docker load -i image-ui.tar
    - docker tag mendersoftware/mantra-ui:${CI_COMMIT_REF_SLUG} mendersoftware/mantra-ui:pr
    - apk add --no-cache python3
    - pip3 install --ignore-installed tox
    - echo $'[api]\nbase_url = http://test:test@docker/api' > backend/tetra-test.conf
  script:
    - docker compose -f docker-compose.yml -f docker-compose.test.yml up -d db
    - sleep 10
    - docker compose -f docker-compose.yml -f docker-compose.test.yml up --no-recreate -d
    - cd backend
    - TOXENV=functional tox

publish:image:ui:
  extends: publish:image
  dependencies:
    - build:docker:ui
  variables:
    DOCKER_REPOSITORY: mendersoftware/mantra-ui
    DOCKER_DIR: ui

sync:image:ui:
  extends: sync:image
  dependencies:
    - publish:image:ui
  variables:
    DOCKER_REPOSITORY: mendersoftware/mantra-ui
    TARGET_MANIFEST_FILE: kubernetes/mender-qastatus/ui-deployment.yaml
